#!/usr/bin/env bash

set -e

. /etc/openvpn/scw-vars.sh


if [ -d "${easyrsa}" ]; then
    echo "Found an existing easy-rsa dir in ${easyrsa}."
    echo "Remove it by yourself if you really want to regenerate"
    echo "the CA and server certs."
    exit 1
fi


logdo () {
    echo ">> Running $@"
    local program="$1"
    shift
    "$program" "$@"
}

mkdir -p "${easyrsa}"
cp vars "${easyrsa}"
cd "${easyrsa}"
cp -a /usr/share/easy-rsa/* .

./easyrsa init-pki
./easyrsa build-ca nopass
./easyrsa gen-crl
./easyrsa build-server-full myvpn nopass

logdo openvpn --genkey --secret "${easyrsa}/pki/ta.key"

touch "${easyrsa}"/done

systemctl disable init-openvpn